<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DineShare | P2P File Transfer</title>
    
    <meta name="theme-color" content="#f97316">
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/2885/2885417.png" type="image/png">

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    
    <style>
        :root { --brand: #f97316; --bg: #fff7ed; --card: #ffffff; --text: #431407; --error: #ef4444; }
        * { box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; }
        body { background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; padding: 20px; }
        
        .main-container { width: 100%; max-width: 450px; display: flex; flex-direction: column; gap: 15px; }
        .card { background: var(--card); border-radius: 24px; padding: 30px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); border: 1px solid #ffedd5; }
        
        .ds-sys-footer-info { width: 100%; min-height: 250px; background: #fff; border-radius: 16px; display: flex; align-items: center; justify-content: center; border: 1px solid #ffedd5; overflow: hidden; margin-top: 10px; }

        h1 { color: var(--brand); text-align: center; margin: 0; font-size: 34px; letter-spacing: -1.5px; }
        .tagline { text-align: center; font-size: 13px; color: #9a3412; margin-bottom: 20px; opacity: 0.7; font-weight: bold; }
        
        .tabs { display: flex; background: #ffedd5; padding: 5px; border-radius: 14px; margin-bottom: 20px; }
        .tab-btn { flex: 1; border: none; padding: 12px; border-radius: 10px; cursor: pointer; font-weight: bold; background: transparent; color: #c2410c; }
        .tab-btn.active { background: white; color: var(--brand); box-shadow: 0 2px 6px rgba(0,0,0,0.06); }
        
        .panel { display: none; }
        .panel.active { display: block; }

        .btn { width: 100%; padding: 16px; border: none; border-radius: 12px; background: var(--brand); color: white; font-weight: bold; font-size: 16px; cursor: pointer; transition: 0.2s; }
        .btn:disabled { background: #fed7aa; cursor: not-allowed; }
        .btn-outline { background: transparent; border: 2px solid var(--brand); color: var(--brand); margin-top: 10px; }
        
        .file-box { border: 2px dashed #fdba74; border-radius: 12px; padding: 30px; text-align: center; margin-bottom: 15px; background: #fffcf9; cursor: pointer; display: block; }
        .file-box.locked { opacity: 0.5; pointer-events: none; }
        
        .code-view { font-size: 48px; font-weight: 900; color: var(--brand); text-align: center; margin: 5px 0; letter-spacing: 5px; font-family: monospace; }
        .progress-cont { height: 12px; background: #ffedd5; border-radius: 6px; overflow: hidden; margin: 15px 0; display: none; }
        .progress-bar { width: 0%; height: 100%; background: var(--brand); transition: width 0.1s; }
        .status-text { text-align: center; font-size: 13px; font-weight: 700; color: #9a3412; padding: 10px; border-radius: 8px; background: #fff7ed; }
        
        /* Internet Prompt UI */
        .internet-prompt { display: none; margin-top: 15px; padding: 15px; border-radius: 12px; background: #fee2e2; border: 1px solid #fca5a5; }
        .internet-prompt h3 { margin: 0 0 10px 0; color: #b91c1c; font-size: 16px; }
        .internet-prompt p { font-size: 13px; color: #991b1b; margin: 0 0 15px 0; line-height: 1.4; }
        
        .troubleshoot-box { background: rgba(255,255,255,0.6); padding: 10px; border-radius: 8px; font-size: 12px; color: #7f1d1d; margin-bottom: 15px; }
        .troubleshoot-box ul { margin: 5px 0 0; padding-left: 20px; }
    </style>
</head>
<body>

<div class="main-container">
    <div class="card">
        <h1>DineShare</h1>
        <div class="tagline">P2P File Transfer (Local & Internet)</div>

        <div class="tabs">
            <button class="tab-btn active" id="btn-send-tab" onclick="setMode('send')">Send</button>
            <button class="tab-btn" id="btn-receive-tab" onclick="setMode('receive')">Receive</button>
        </div>

        <div id="sendPanel" class="panel active">
            <label class="file-box" id="file-drop-zone">
                <input type="file" id="filePicker" multiple hidden onchange="filesReady()">
                <div id="fileStatus">üìÅ Select Files</div>
            </label>
            <button class="btn" id="genBtn" onclick="initSender()" disabled>Generate Code</button>
            
            <div id="codeArea" style="display:none">
                <div class="code-view" id="codeDisplay">------</div>
                <div style="text-align:center; font-size:12px; color:var(--brand); font-weight:bold;" id="timer">Expires in 60s</div>
            </div>

            <div id="internetPrompt" class="internet-prompt">
                <h3>üåê Receiver is not on your Local Network</h3>
                <p>A direct local connection failed. You can still send the files securely over the internet, but it will consume data and may be slower.</p>
                
                <div class="troubleshoot-box">
                    <b>Why did this happen?</b>
                    <ul>
                        <li>Devices are on different Wi-Fi networks.</li>
                        <li><b>Guest Wi-Fi Isolation</b> is blocking device-to-device communication.</li>
                        <li>A strict <b>Firewall, VPN, or Antivirus</b> is blocking local ports.</li>
                    </ul>
                </div>

                <button class="btn" onclick="startTransferData()">Send Over Internet Anyway</button>
                <button class="btn btn-outline" onclick="cancelTransfer()">Cancel</button>
            </div>
        </div>

        <div id="receivePanel" class="panel">
            <input type="text" id="joinCode" placeholder="ENTER CODE" maxlength="6" style="width:100%; padding:16px; border-radius:12px; border:2px solid #fdba74; font-size:24px; text-align:center; font-weight:bold; margin-bottom:15px; text-transform:uppercase; outline: none;">
            <button class="btn" id="joinBtn" onclick="initReceiver()">Join & Download</button>
        </div>

        <div id="transferInfo" style="margin-top:20px;">
            <div class="status-text" id="currentStatus">Ready</div>
            <div class="progress-cont" id="pCont"><div class="progress-bar" id="pBar"></div></div>
        </div>
    </div>

    </div>

<script>
    // --- KILL GHOST SERVICE WORKERS (Fixes network interception errors) ---
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(function(registrations) {
            for(let registration of registrations) {
                registration.unregister();
            }
        });
    }

    // --- FIREBASE CONFIG (Make sure to put your real keys here) ---


    const firebaseConfig = {

  apiKey: "AIzaSyBogCw9T7aR5nEyUmOOKEPEoI12hQn0sdQ",

  authDomain: "dineshare-777.firebaseapp.com",

  databaseURL: "https://dineshare-777-default-rtdb.firebaseio.com",

  projectId: "dineshare-777",

  storageBucket: "dineshare-777.firebasestorage.app",

  messagingSenderId: "550153382278",

  appId: "1:550153382278:web:87afc164c90ed260f2e407",

  measurementId: "G-67D64MYS4D"

};

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    // Google STUN server for NAT traversal
    const rtcConfig = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

    let pc, dc, files = [], expirationTimer;
    let roomRefGlobal = null;

    // --- CLEANUP ON TAB CLOSE ---
    window.addEventListener('beforeunload', () => {
        if (roomRefGlobal) roomRefGlobal.remove(); 
        if (pc) pc.close(); 
    });

    // --- UI LOGIC ---
    function setMode(mode) {
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(mode + 'Panel').classList.add('active');
        document.getElementById('btn-' + mode + '-tab').classList.add('active');
    }

    function filesReady() {
        files = Array.from(document.getElementById('filePicker').files);
        if(files.length > 0) {
            document.getElementById('fileStatus').innerHTML = `<b>${files.length} Files Selected</b>`;
            document.getElementById('genBtn').disabled = false;
        }
    }

    function lockUI() {
        document.querySelectorAll('.btn, .tab-btn, input').forEach(el => el.disabled = true);
        document.getElementById('file-drop-zone').classList.add('locked');
    }

    // --- CHECK CONNECTION TYPE ---
    async function isLocalConnection(peerConnection) {
        try {
            const stats = await peerConnection.getStats();
            let isLocal = false;
            stats.forEach(report => {
                if (report.type === 'candidate-pair' && report.state === 'succeeded') {
                    const local = stats.get(report.localCandidateId);
                    const remote = stats.get(report.remoteCandidateId);
                    if (local && remote && local.candidateType === 'host' && remote.candidateType === 'host') {
                        isLocal = true;
                    }
                }
            });
            return isLocal;
        } catch (e) { return false; }
    }

    // --- SENDER ---
    async function initSender() {
        if (!navigator.onLine) {
            alert("‚ùå No internet connection. You need internet to generate a connection code.");
            return;
        }

        lockUI();
        const code = Math.random().toString(36).substring(2, 8).toUpperCase();
        document.getElementById('codeDisplay').innerText = code;
        document.getElementById('codeArea').style.display = 'block';
        document.getElementById('currentStatus').innerText = "Waiting for receiver...";

        pc = new RTCPeerConnection(rtcConfig);
        dc = pc.createDataChannel("dineData");
        
        pc.oniceconnectionstatechange = () => {
            if (pc.iceConnectionState === "disconnected" || pc.iceConnectionState === "failed") {
                document.getElementById('currentStatus').innerText = "‚ùå Connection Lost! Peer disconnected.";
                document.getElementById('currentStatus').style.color = "var(--error)";
            }
        };

        dc.onopen = async () => {
            db.goOffline(); // Disconnect from Firebase instantly
            clearInterval(expirationTimer);
            if (roomRefGlobal) roomRefGlobal.remove(); 

            const local = await isLocalConnection(pc);
            
            if (local) {
                document.getElementById('currentStatus').innerText = "‚ö° Local connection established. Sending...";
                startTransferData();
            } else {
                document.getElementById('currentStatus').innerText = "‚ö†Ô∏è Checking connection route...";
                document.getElementById('codeArea').style.display = 'none';
                document.getElementById('internetPrompt').style.display = 'block';
            }
        };

        const roomRef = db.ref('dineshare_rooms/' + code);
        roomRefGlobal = roomRef;
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        
        try {
            await roomRef.set({ offer: { sdp: offer.sdp, type: offer.type } });
        } catch (err) {
            alert("‚ùå Failed to connect to signaling server. Please check your network.");
            return;
        }

        let timeLeft = 60;
        expirationTimer = setInterval(() => {
            timeLeft--;
            document.getElementById('timer').innerText = `Expires in ${timeLeft}s`;
            if (timeLeft <= 0) {
                clearInterval(expirationTimer);
                roomRef.remove();
                document.getElementById('currentStatus').innerText = "Expired. Refresh to start over.";
                pc.close();
            }
        }, 1000);

        roomRef.child('answer').on('value', snap => {
            if(snap.val() && !pc.currentRemoteDescription) pc.setRemoteDescription(new RTCSessionDescription(snap.val()));
        });

        pc.onicecandidate = e => {
            if (e.candidate) roomRef.child('sCand').push(e.candidate.toJSON());
        };
        roomRef.child('rCand').on('child_added', snap => pc.addIceCandidate(new RTCIceCandidate(snap.val())));
    }

    function cancelTransfer() {
        if (pc) pc.close();
        document.getElementById('internetPrompt').style.display = 'none';
        document.getElementById('currentStatus').innerText = "Transfer Cancelled. Refresh the page.";
    }

    async function startTransferData() {
        document.getElementById('internetPrompt').style.display = 'none';
        document.getElementById('pCont').style.display = 'block';
        
        for (let file of files) {
            if (pc.iceConnectionState === "disconnected" || pc.iceConnectionState === "failed") break;

            document.getElementById('currentStatus').innerText = `Sending: ${file.name}`;
            dc.send(JSON.stringify({ name: file.name, size: file.size, type: file.type }));
            
            let offset = 0;
            const CHUNK = 16384;
            while (offset < file.size) {
                if (pc.iceConnectionState === "disconnected") break; 
                if (dc.bufferedAmount > 1000000) await new Promise(r => setTimeout(r, 45));
                const buf = await file.slice(offset, offset + CHUNK).arrayBuffer();
                dc.send(buf);
                offset += buf.byteLength;
                document.getElementById('pBar').style.width = (offset / file.size * 100) + '%';
            }
            dc.send("DONE");
        }
        
        if (pc.iceConnectionState === "connected") {
            document.getElementById('currentStatus').innerText = "‚úÖ All Files Sent Successfully!";
            setTimeout(() => { if (pc) pc.close(); }, 2000);
        }
    }

    // --- RECEIVER ---
    async function initReceiver() {
        if (!navigator.onLine) {
            alert("‚ùå No internet connection. You need internet to join a room.");
            return;
        }

        const code = document.getElementById('joinCode').value.toUpperCase();
        if(!code) return;
        
        const roomRef = db.ref('dineshare_rooms/' + code);
        roomRefGlobal = roomRef;

        try {
            const snap = await roomRef.child('offer').once('value');
            if(!snap.exists()) return alert("‚ùå Code Expired or Invalid");
            
            lockUI();
            document.getElementById('currentStatus').innerText = "Connecting...";
            pc = new RTCPeerConnection(rtcConfig);
            
            pc.oniceconnectionstatechange = () => { 
                if (pc.iceConnectionState === "connected") {
                    db.goOffline(); 
                } else if (pc.iceConnectionState === "disconnected" || pc.iceConnectionState === "failed") {
                    document.getElementById('currentStatus').innerText = "‚ùå Connection Lost! Sender disconnected.";
                    document.getElementById('currentStatus').style.color = "var(--error)";
                }
            };

            pc.ondatachannel = e => {
                let meta, chunks = [], received = 0;
                document.getElementById('pCont').style.display = 'block';
                e.channel.onmessage = msg => {
                    if (typeof msg.data === 'string') {
                        if (msg.data === "DONE") {
                            const blob = new Blob(chunks, { type: meta.type });
                            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = meta.name; a.click();
                            chunks = []; received = 0;
                            document.getElementById('currentStatus').innerText = "‚úÖ Download Complete";
                        } else {
                            meta = JSON.parse(msg.data);
                            document.getElementById('currentStatus').innerText = `Receiving: ${meta.name}`;
                        }
                    } else {
                        chunks.push(msg.data);
                        received += msg.data.byteLength;
                        document.getElementById('pBar').style.width = (received / meta.size * 100) + '%';
                    }
                };
            };

            await pc.setRemoteDescription(new RTCSessionDescription(snap.val()));
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            roomRef.child('answer').set({ sdp: answer.sdp, type: answer.type });

            pc.onicecandidate = e => {
                if (e.candidate) roomRef.child('rCand').push(e.candidate.toJSON());
            };
            roomRef.child('rCand').on('child_added', snap => pc.addIceCandidate(new RTCIceCandidate(snap.val())));

        } catch (err) {
            alert("‚ùå Failed to communicate with server. Check connection.");
        }
    }
</script>
</body>
</html>
