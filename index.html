<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DineShare | Local P2P</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        :root { --primary: #10b981; --bg: #f0fdf4; }
        body { font-family: sans-serif; background: var(--bg); display: flex; justify-content: center; padding: 20px; }
        .card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); width: 100%; max-width: 400px; text-align: center; }
        input, button { width: 100%; padding: 12px; margin: 10px 0; border-radius: 6px; border: 1px solid #ddd; box-sizing: border-box; }
        button { background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; }
        .progress-cont { height: 10px; background: #eee; border-radius: 5px; overflow: hidden; display: none; margin: 10px 0; }
        .progress-bar { width: 0%; height: 100%; background: var(--primary); transition: width 0.1s; }
        .status { font-size: 14px; color: #666; margin-top: 10px; }
    </style>
</head>
<body>

<div class="card">
    <h2 style="color:var(--primary)">DineShare Local</h2>
    <p style="font-size:12px; color:#666;">Devices must be on the same Wi-Fi</p>
    
    <div id="setupView">
        <input type="file" id="fileInput" multiple onchange="document.getElementById('sendBtn').disabled = false">
        <button id="sendBtn" onclick="startSender()" disabled>Generate Code</button>
        <div id="displayCode" style="font-size:32px; font-weight:bold; margin: 15px 0;"></div>
        <hr>
        <input type="text" id="inputCode" placeholder="Enter 6-digit code" maxlength="6">
        <button onclick="startReceiver()">Receive Files</button>
    </div>

    <div id="transferView">
        <div id="statusText" class="status">Ready</div>
        <div class="progress-cont" id="pCont"><div class="progress-bar" id="pBar"></div></div>
    </div>
</div>

<script>
    // --- CONFIGURATION ---
const firebaseConfig = {

  apiKey: "AIzaSyA-NhlaD3XRLKEf_y6xCMOElXnx5IVWhIg",

  authDomain: "dineshare-web.firebaseapp.com",

  databaseURL: "https://dineshare-web-default-rtdb.firebaseio.com",

  projectId: "dineshare-web",

  storageBucket: "dineshare-web.firebasestorage.app",

  messagingSenderId: "456148087993",

  appId: "1:456148087993:web:041e5569a4722b64795768",

  measurementId: "G-633V93EBW6"

};



    
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const iceConfig = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
    
    let pc, dc, files = [];

    // --- SENDER ---
    async function startSender() {
        files = Array.from(document.getElementById('fileInput').files);
        const code = Math.random().toString(36).substring(2, 8).toUpperCase();
        document.getElementById('displayCode').innerText = code;
        document.getElementById('statusText').innerText = "Waiting for receiver...";

        pc = new RTCPeerConnection(iceConfig);
        dc = pc.createDataChannel("transfer");
        dc.onopen = () => sendAllFiles();

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        
        const roomRef = db.ref('local_rooms/' + code);
        roomRef.set({ offer: { sdp: offer.sdp, type: offer.type } });
        roomRef.child('answer').on('value', snap => snap.val() && pc.setRemoteDescription(new RTCSessionDescription(snap.val())));
        pc.onicecandidate = e => e.candidate && roomRef.child('sCand').push(e.candidate.toJSON());
        roomRef.child('rCand').on('child_added', snap => pc.addIceCandidate(new RTCIceCandidate(snap.val())));
    }

    async function sendAllFiles() {
        document.getElementById('pCont').style.display = 'block';
        for (let file of files) {
            document.getElementById('statusText').innerText = `Sending: ${file.name}`;
            dc.send(JSON.stringify({ name: file.name, size: file.size, type: file.type }));
            
            let offset = 0;
            const chunk = 16384;
            while (offset < file.size) {
                if (dc.bufferedAmount > 1000000) await new Promise(r => setTimeout(r, 50));
                const data = await file.slice(offset, offset + chunk).arrayBuffer();
                dc.send(data);
                offset += data.byteLength;
                document.getElementById('pBar').style.width = (offset / file.size * 100) + '%';
            }
            dc.send("EOF");
        }
        document.getElementById('statusText').innerText = "Done!";
    }

    // --- RECEIVER ---
    async function startReceiver() {
        const code = document.getElementById('inputCode').value.toUpperCase();
        const roomRef = db.ref('local_rooms/' + code);
        const snap = await roomRef.child('offer').once('value');
        if (!snap.exists()) return alert("Code not found");

        pc = new RTCPeerConnection(iceConfig);
        pc.ondatachannel = e => setupDC(e.channel);
        
        await pc.setRemoteDescription(new RTCSessionDescription(snap.val()));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        roomRef.child('answer').set({ sdp: answer.sdp, type: answer.type });

        pc.onicecandidate = e => e.candidate && roomRef.child('rCand').push(e.candidate.toJSON());
        roomRef.child('sCand').on('child_added', snap => pc.addIceCandidate(new RTCIceCandidate(snap.val())));
    }

    function setupDC(channel) {
        let meta, chunks = [], received = 0;
        document.getElementById('pCont').style.display = 'block';
        channel.onmessage = e => {
            if (typeof e.data === 'string') {
                if (e.data === "EOF") {
                    const blob = new Blob(chunks, { type: meta.type });
                    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = meta.name; a.click();
                    chunks = []; received = 0;
                } else {
                    meta = JSON.parse(e.data);
                    document.getElementById('statusText').innerText = `Receiving: ${meta.name}`;
                }
            } else {
                chunks.push(e.data);
                received += e.data.byteLength;
                document.getElementById('pBar').style.width = (received / meta.size * 100) + '%';
            }
        };
    }
</script>
</body>
</html>
