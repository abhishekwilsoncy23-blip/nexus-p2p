<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DineShare | Secure P2P Transfer</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    
    <style>
        :root { --brand: #f97316; --bg: #fff7ed; --card: #ffffff; --text: #431407; --gray: #94a3b8; --success: #22c55e; --error: #ef4444; }
        * { box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; }
        body { background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; padding: 20px; }
        
        /* Layout */
        .main-container { width: 100%; max-width: 450px; display: flex; flex-direction: column; gap: 15px; }
        .card { background: var(--card); border-radius: 24px; padding: 30px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); border: 1px solid #ffedd5; }
        
        /* Ad & Anti-Adblock Section */
        .ad-slot { width: 100%; min-height: 280px; background: #fff; border-radius: 16px; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 1px dashed #fdba74; overflow: hidden; position: relative; }
        #ab-notice { display: none; padding: 20px; text-align: center; }

        h1 { color: var(--brand); text-align: center; margin: 0; font-size: 34px; letter-spacing: -1.5px; }
        .tagline { text-align: center; font-size: 13px; color: #9a3412; margin-bottom: 20px; opacity: 0.7; }
        
        .tabs { display: flex; background: #ffedd5; padding: 5px; border-radius: 14px; margin-bottom: 20px; }
        .tab-btn { flex: 1; border: none; padding: 12px; border-radius: 10px; cursor: pointer; font-weight: bold; background: transparent; color: #c2410c; }
        .tab-btn.active { background: white; color: var(--brand); box-shadow: 0 2px 6px rgba(0,0,0,0.06); }

        .panel { display: none; }
        .panel.active { display: block; }

        .btn { width: 100%; padding: 16px; border: none; border-radius: 12px; background: var(--brand); color: white; font-weight: bold; font-size: 16px; cursor: pointer; transition: 0.2s; }
        .btn:disabled { background: #fed7aa; cursor: not-allowed; }
        
        .file-box { border: 2px dashed #fdba74; border-radius: 12px; padding: 30px; text-align: center; margin-bottom: 15px; background: #fffcf9; cursor: pointer; display: block; }
        .code-view { font-size: 48px; font-weight: 900; color: var(--brand); text-align: center; margin: 5px 0; letter-spacing: 5px; font-family: monospace; }
        .timer-text { text-align: center; font-size: 12px; color: var(--error); font-weight: bold; margin-bottom: 15px; }
        
        .progress-cont { height: 12px; background: #ffedd5; border-radius: 6px; overflow: hidden; margin: 15px 0; display: none; }
        .progress-bar { width: 0%; height: 100%; background: var(--brand); transition: width 0.1s; }
        .status-text { text-align: center; font-size: 13px; font-weight: 700; color: #9a3412; padding: 10px; border-radius: 8px; background: #fff7ed; }
    </style>
</head>
<body>

<div class="main-container">
    <div class="card">
        <h1>DineShare</h1>
        <div class="tagline">Ultra-Fast Peer-to-Peer Transfer</div>

        <div class="tabs">
            <button class="tab-btn active" id="btn-send" onclick="setMode('send')">Send</button>
            <button class="tab-btn" id="btn-receive" onclick="setMode('receive')">Receive</button>
        </div>

        <div id="sendPanel" class="panel active">
            <label class="file-box">
                <input type="file" id="filePicker" multiple hidden onchange="filesReady()">
                <div id="fileStatus">üìÅ Tap to pick files</div>
            </label>
            <button class="btn" id="genBtn" onclick="initSender()" disabled>Generate 60s Code</button>
            <div id="codeArea" style="display:none">
                <div class="code-view" id="codeDisplay">------</div>
                <div class="timer-text" id="timer">Code expires in 60s</div>
            </div>
        </div>

        <div id="receivePanel" class="panel">
            <input type="text" id="joinCode" placeholder="ENTER CODE" maxlength="6" style="width:100%; padding:16px; border-radius:12px; border:2px solid #fdba74; font-size:24px; text-align:center; font-weight:bold; margin-bottom:15px; text-transform:uppercase; outline: none;">
            <button class="btn" onclick="initReceiver()">Join & Download</button>
        </div>

        <div id="transferInfo" style="margin-top:20px;">
            <div class="status-text" id="currentStatus">Ready</div>
            <div class="progress-cont" id="pCont"><div class="progress-bar" id="pBar"></div></div>
        </div>
    </div>

    <div class="ad-slot" id="ad-wrapper">
        <div id="ad-placeholder" style="width:100%; text-align:center;">
            <div style="color:#fdba74; font-size:10px; font-weight:bold; margin-bottom:5px;">ADVERTISEMENT</div>
            
            <script type="text/javascript">
                atOptions = { 'key' : 'YOUR_KEY', 'format' : 'iframe', 'height' : 250, 'width' : 300, 'params' : {} };
            </script>
            <script type="text/javascript" src="//www.highperformanceformat.com/YOUR_ID/invoke.js"></script>
        </div>

        <div id="ab-notice">
            <div style="font-size:30px;">üéÅ</div>
            <div style="font-size:14px; font-weight:bold; color:var(--error);">Adblocker Active</div>
            <div style="font-size:11px; color:#9a3412; margin-top:4px;">Please disable adblock to keep DineShare free!</div>
        </div>
    </div>
    
    <div style="font-size: 10px; text-align:center; color:#9a3412; opacity:0.5; margin-top:5px;">
        DineShare v2.4 ‚Ä¢ High-Scale Connection Optimized
    </div>
</div>

<script>
    // --- 1. FIREBASE CONFIG ---
const firebaseConfig = {

  apiKey: "AIzaSyA-NhlaD3XRLKEf_y6xCMOElXnx5IVWhIg",

  authDomain: "dineshare-web.firebaseapp.com",

  databaseURL: "https://dineshare-web-default-rtdb.firebaseio.com",

  projectId: "dineshare-web",

  storageBucket: "dineshare-web.firebasestorage.app",

  messagingSenderId: "456148087993",

  appId: "1:456148087993:web:041e5569a4722b64795768",

  measurementId: "G-633V93EBW6"

};

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const rtcConfig = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

    let pc, dc, files = [], expirationTimer;

    // --- 2. ANTI-ADBLOCK LOGIC ---
    window.addEventListener('load', () => {
        setTimeout(() => {
            const ad = document.getElementById('ad-placeholder');
            if (ad.offsetHeight < 20) {
                ad.style.display = 'none';
                document.getElementById('ab-notice').style.display = 'block';
            }
        }, 3500);
    });

    function setMode(mode) {
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(mode + 'Panel').classList.add('active');
        document.getElementById('btn-' + mode).classList.add('active');
    }

    function filesReady() {
        files = Array.from(document.getElementById('filePicker').files);
        document.getElementById('fileStatus').innerHTML = `<b>${files.length} Files Ready</b>`;
        document.getElementById('genBtn').disabled = false;
    }

    // --- 3. SENDER CORE ---
    async function initSender() {
        const code = Math.random().toString(36).substring(2, 8).toUpperCase();
        document.getElementById('codeDisplay').innerText = code;
        document.getElementById('codeArea').style.display = 'block';
        document.getElementById('genBtn').style.display = 'none';

        pc = new RTCPeerConnection(rtcConfig);
        dc = pc.createDataChannel("dineData");
        
        // P2P Optimization: Go offline from Firebase once connected
        pc.oniceconnectionstatechange = () => {
            if (pc.iceConnectionState === "connected" || pc.iceConnectionState === "completed") {
                db.goOffline(); 
                clearInterval(expirationTimer);
                document.getElementById('timer').innerText = "DIRECT P2P ENCRYPTED";
                document.getElementById('timer').style.color = "var(--success)";
            }
        };

        dc.onopen = () => transferData();

        const roomRef = db.ref('dineshare_rooms/' + code);
        roomRef.onDisconnect().remove(); 

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        await roomRef.set({ offer: { sdp: offer.sdp, type: offer.type } });

        let timeLeft = 60;
        expirationTimer = setInterval(() => {
            timeLeft--;
            document.getElementById('timer').innerText = `Code expires in ${timeLeft}s`;
            if (timeLeft <= 0) {
                clearInterval(expirationTimer);
                roomRef.remove();
                document.getElementById('codeDisplay').style.color = "var(--gray)";
                document.getElementById('currentStatus').innerText = "Code Expired. Refresh page.";
            }
        }, 1000);

        roomRef.child('answer').on('value', snap => {
            if(snap.val() && !pc.currentRemoteDescription) pc.setRemoteDescription(new RTCSessionDescription(snap.val()));
        });

        pc.onicecandidate = e => e.candidate && roomRef.child('sCand').push(e.candidate.toJSON());
        roomRef.child('rCand').on('child_added', snap => pc.addIceCandidate(new RTCIceCandidate(snap.val())));
    }

    async function transferData() {
        document.getElementById('pCont').style.display = 'block';
        for (let file of files) {
            document.getElementById('currentStatus').innerText = `Sending: ${file.name}`;
            dc.send(JSON.stringify({ name: file.name, size: file.size, type: file.type }));
            let offset = 0;
            const CHUNK = 16384;
            while (offset < file.size) {
                if (dc.bufferedAmount > 1000000) await new Promise(r => setTimeout(r, 45));
                const buf = await file.slice(offset, offset + CHUNK).arrayBuffer();
                dc.send(buf);
                offset += buf.byteLength;
                document.getElementById('pBar').style.width = (offset / file.size * 100) + '%';
            }
            dc.send("DONE");
        }
        document.getElementById('currentStatus').innerText = "‚úÖ Files Sent Successfully!";
    }

    // --- 4. RECEIVER CORE ---
    async function initReceiver() {
        const code = document.getElementById('joinCode').value.toUpperCase();
        if(!code) return;
        const roomRef = db.ref('dineshare_rooms/' + code);
        const snap = await roomRef.child('offer').once('value');
        if(!snap.exists()) return alert("Invalid or Expired Code");

        document.getElementById('currentStatus').innerText = "Connecting...";
        pc = new RTCPeerConnection(rtcConfig);
        
        pc.oniceconnectionstatechange = () => {
            if (pc.iceConnectionState === "connected" || pc.iceConnectionState === "completed") {
                db.goOffline(); 
            }
        };

        pc.ondatachannel = e => {
            let meta, chunks = [], received = 0;
            document.getElementById('pCont').style.display = 'block';
            e.channel.onmessage = msg => {
                if (typeof msg.data === 'string') {
                    if (msg.data === "DONE") {
                        const blob = new Blob(chunks, { type: meta.type });
                        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = meta.name; a.click();
                        chunks = []; received = 0;
                    } else {
                        meta = JSON.parse(msg.data);
                        document.getElementById('currentStatus').innerText = `Receiving: ${meta.name}`;
                    }
                } else {
                    chunks.push(msg.data);
                    received += msg.data.byteLength;
                    document.getElementById('pBar').style.width = (received / meta.size * 100) + '%';
                }
            };
        };

        await pc.setRemoteDescription(new RTCSessionDescription(snap.val()));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        roomRef.child('answer').set({ sdp: answer.sdp, type: answer.type });

        pc.onicecandidate = e => e.candidate && roomRef.child('rCand').push(e.candidate.toJSON());
        roomRef.child('sCand').on('child_added', snap => pc.addIceCandidate(new RTCIceCandidate(snap.val())));
    }
</script>
</body>
</html>
