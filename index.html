<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DineShare | P2P File Transfer</title>
    <script src="https://cdn.jsdelivr.net/npm/streamsaver@2.0.5/StreamSaver.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    
    <style>
        :root { --primary: #6366f1; --bg: #f8fafc; --card: #ffffff; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; color: #1e293b; }
        .container { width: 90%; max-width: 500px; background: var(--card); margin-top: 50px; padding: 30px; border-radius: 16px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); text-align: center; }
        h1 { margin-top: 0; color: var(--primary); font-size: 24px; }
        .tab-buttons { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { flex: 1; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; background: #e2e8f0; transition: 0.3s; }
        .tab-btn.active { background: var(--primary); color: white; }
        .panel { display: none; }
        .panel.active { display: block; }
        input[type="file"], input[type="text"] { width: 100%; padding: 12px; margin: 15px 0; border: 2px border #e2e8f0; border-radius: 8px; box-sizing: border-box; }
        button.action-btn { width: 100%; padding: 15px; border: none; border-radius: 8px; background: var(--primary); color: white; font-size: 16px; font-weight: bold; cursor: pointer; }
        .status { margin-top: 15px; font-size: 14px; color: #64748b; min-height: 20px; font-weight: 500; }
        .progress-cont { width: 100%; height: 10px; background: #e2e8f0; border-radius: 5px; margin-top: 20px; overflow: hidden; display: none; }
        .progress-bar { width: 0%; height: 100%; background: var(--primary); transition: width 0.1s; }
        
        /* AD SPACE - Optimized for Native Banners */
        .ad-slot { margin-top: 30px; width: 100%; max-width: 500px; min-height: 100px; background: #f1f5f9; border-radius: 8px; display: flex; align-items: center; justify-content: center; border: 1px dashed #cbd5e1; flex-direction: column; }
    </style>
</head>
<body>

    <div class="container">
        <h1>DineShare</h1>
        <div class="tab-buttons">
            <button class="tab-btn active" onclick="switchTab('send')">Send</button>
            <button class="tab-btn" onclick="switchTab('receive')">Receive</button>
        </div>

        <div id="sendPanel" class="panel active">
            <input type="file" id="fileInput">
            <button class="action-btn" onclick="startSending()">Generate 6-Digit Code</button>
            <div id="sendCodeDisplay" style="font-size: 32px; font-weight: bold; margin-top: 20px; letter-spacing: 5px; color: var(--primary);"></div>
            <div id="sendStatus" class="status">Select a file to begin</div>
            <div class="progress-cont" id="sendProgressCont"><div class="progress-bar" id="sendProgressBar"></div></div>
        </div>

        <div id="receivePanel" class="panel">
            <input type="text" id="joinCode" placeholder="Enter 6-digit code" maxlength="6">
            <button class="action-btn" onclick="startReceiving()">Connect & Download</button>
            <div id="receiveStatus" class="status">Enter code from sender</div>
            <div class="progress-cont" id="receiveProgressCont"><div class="progress-bar" id="receiveProgressBar"></div></div>
        </div>
    </div>

    <div class="ad-slot">
        <p style="color: #94a3b8; font-size: 12px; margin: 0;">Sponsored Content</p>
    </div>
    <script>
        // 1. FIREBASE CONFIGURATION (REPLACE WITH YOURS)
const firebaseConfig = {

  apiKey: "AIzaSyA-NhlaD3XRLKEf_y6xCMOElXnx5IVWhIg",

  authDomain: "dineshare-web.firebaseapp.com",

  databaseURL: "https://dineshare-web-default-rtdb.firebaseio.com",

  projectId: "dineshare-web",

  storageBucket: "dineshare-web.firebasestorage.app",

  messagingSenderId: "456148087993",

  appId: "1:456148087993:web:041e5569a4722b64795768",

  measurementId: "G-633V93EBW6"

};


        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // 2. GLOBALS
        let pc, dataChannel;
        const CHUNK_SIZE = 16384; 
        const configuration = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

        // 3. UI LOGIC
        function switchTab(tab) {
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tab + 'Panel').classList.add('active');
            event.target.classList.add('active');
        }

        // 4. SENDER LOGIC
        async function startSending() {
            const file = document.getElementById('fileInput').files[0];
            if (!file) return alert("Please select a file first!");

            const code = Math.floor(100000 + Math.random() * 900000).toString();
            document.getElementById('sendCodeDisplay').innerText = code;
            document.getElementById('sendStatus').innerText = "Waiting for receiver...";

            pc = new RTCPeerConnection(configuration);
            setupConnectionListeners(pc, 'sendStatus');

            dataChannel = pc.createDataChannel("fileTransfer");
            dataChannel.onopen = () => sendFile(file);

            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);

            const roomRef = db.ref('rooms/' + code);
            roomRef.set({ offer: { type: offer.type, sdp: offer.sdp } });

            // Listen for Receiver's Answer
            roomRef.on('value', async (snapshot) => {
                const data = snapshot.val();
                if (data?.answer && !pc.currentRemoteDescription) {
                    await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
                }
            });

            // Push Sender's ICE Candidates to Firebase
            pc.onicecandidate = e => {
                if (e.candidate) roomRef.child('senderCandidates').push(e.candidate.toJSON());
            };

            // Listen for Receiver's ICE Candidates
            roomRef.child('receiverCandidates').on('child_added', snapshot => {
                pc.addIceCandidate(new RTCIceCandidate(snapshot.val()));
            });
        }

        async function sendFile(file) {
            document.getElementById('sendProgressCont').style.display = 'block';
            dataChannel.send(JSON.stringify({ fileName: file.name, fileSize: file.size }));

            let offset = 0;
            // Buffer control to prevent crashing on massive files
            dataChannel.bufferedAmountLowThreshold = 1024 * 1024; // 1MB

            const readSlice = o => new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.readAsArrayBuffer(file.slice(o, o + CHUNK_SIZE));
            });

            while (offset < file.size) {
                const chunk = await readSlice(offset);
                
                // If the WebRTC pipeline is full, pause and wait for it to clear
                if (dataChannel.bufferedAmount > dataChannel.bufferedAmountLowThreshold) {
                    await new Promise(resolve => {
                        dataChannel.onbufferedamountlow = () => {
                            dataChannel.onbufferedamountlow = null;
                            resolve();
                        };
                    });
                }

                dataChannel.send(chunk);
                offset += chunk.byteLength;
                
                // Update UI every few chunks to save UI thread performance
                if (offset % (CHUNK_SIZE * 50) === 0 || offset >= file.size) {
                    document.getElementById('sendProgressBar').style.width = (offset / file.size * 100) + '%';
                }
            }
            
            document.getElementById('sendStatus').innerText = "âœ… Transfer Complete!";
            cleanup(document.getElementById('sendCodeDisplay').innerText);
        }

        // 5. RECEIVER LOGIC
        async function startReceiving() {
            const code = document.getElementById('joinCode').value;
            if (code.length !== 6) return alert("Enter 6-digit code");

            pc = new RTCPeerConnection(configuration);
            setupConnectionListeners(pc, 'receiveStatus');

            pc.ondatachannel = (event) => setupReceiveChannel(event.channel);

            const roomRef = db.ref('rooms/' + code);
            const snapshot = await roomRef.once('value');
            const data = snapshot.val();

            if (!data) return alert("Room not found!");

            await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            roomRef.update({ answer: { type: answer.type, sdp: answer.sdp } });

            // Push Receiver's ICE Candidates to Firebase
            pc.onicecandidate = e => {
                if (e.candidate) roomRef.child('receiverCandidates').push(e.candidate.toJSON());
            };

            // Listen for Sender's ICE Candidates
            roomRef.child('senderCandidates').on('child_added', (snapshot) => {
                pc.addIceCandidate(new RTCIceCandidate(snapshot.val()));
            });
        }

        function setupReceiveChannel(channel) {
            let writer, fileInfo, receivedSize = 0;

            channel.onmessage = async (e) => {
                if (typeof e.data === 'string') {
                    fileInfo = JSON.parse(e.data);
                    document.getElementById('receiveProgressCont').style.display = 'block';
                    document.getElementById('receiveStatus').innerHTML = `Downloading: <b>${fileInfo.fileName}</b>`;
                    
                    // Create direct-to-disk stream
                    const fileStream = streamSaver.createWriteStream(fileInfo.fileName, { size: fileInfo.fileSize });
                    writer = fileStream.getWriter();
                } else {
                    receivedSize += e.data.byteLength;
                    await writer.write(new Uint8Array(e.data));
                    
                    // Update UI smoothly
                    if (receivedSize % (CHUNK_SIZE * 50) === 0 || receivedSize >= fileInfo.fileSize) {
                        document.getElementById('receiveProgressBar').style.width = (receivedSize / fileInfo.fileSize * 100) + '%';
                    }
                    
                    // Finish download
                    if (receivedSize >= fileInfo.fileSize) {
                        writer.close();
                        document.getElementById('receiveStatus').innerText = "âœ… Download Finished!";
                    }
                }
            };
        }

        // 6. STABILITY & CLEANUP
        function setupConnectionListeners(pc, statusId) {
            pc.oniceconnectionstatechange = () => {
                const state = pc.iceConnectionState;
                if (state === 'connected') {
                    document.getElementById(statusId).innerText = "ðŸŸ¢ Connected! Transferring...";
                } else if (state === 'failed' || state === 'disconnected') {
                    document.getElementById(statusId).innerText = "âŒ Connection Lost. Try again.";
                }
            };
        }

        function cleanup(code) {
            // Delete the room from Firebase to save database space
            setTimeout(() => { db.ref('rooms/' + code).remove(); }, 5000);
        }
    </script>
</body>
</html>
