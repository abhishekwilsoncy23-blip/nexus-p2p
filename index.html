<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DineShare | P2P Transfer</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    
    <style>
        :root { --primary: #6366f1; --bg: #f8fafc; --card: #ffffff; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; color: #1e293b; }
        .container { width: 90%; max-width: 500px; background: var(--card); margin-top: 40px; padding: 30px; border-radius: 16px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); text-align: center; }
        h1 { margin-top: 0; color: var(--primary); font-size: 26px; margin-bottom: 5px; }
        .subtitle { font-size: 13px; color: #64748b; margin-bottom: 25px; }
        
        .tab-buttons { display: flex; gap: 10px; margin-bottom: 25px; }
        .tab-btn { flex: 1; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; background: #e2e8f0; transition: 0.3s; color: #475569; }
        .tab-btn.active { background: var(--primary); color: white; }
        .panel { display: none; }
        .panel.active { display: block; }
        
        .network-select { width: 100%; padding: 12px; margin-bottom: 20px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; background: #f8fafc; cursor: pointer; color: #1e293b; font-weight: 500;}
        
        .upload-btn { display: block; width: 100%; padding: 15px; background: #f1f5f9; border: 2px dashed #cbd5e1; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px; transition: 0.2s; box-sizing: border-box; margin-bottom: 15px; }
        .upload-btn:hover { border-color: var(--primary); color: var(--primary); }
        
        input[type="text"] { width: 100%; padding: 15px; margin: 10px 0 20px 0; border: 2px solid #e2e8f0; border-radius: 8px; box-sizing: border-box; font-size: 16px; text-align: center; letter-spacing: 2px; }
        button.action-btn { width: 100%; padding: 15px; border: none; border-radius: 8px; background: var(--primary); color: white; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        button.action-btn:disabled { background: #94a3b8; cursor: not-allowed; }
        
        .status { margin-top: 20px; font-size: 15px; color: #64748b; min-height: 20px; font-weight: 500; }
        .progress-cont { width: 100%; height: 8px; background: #e2e8f0; border-radius: 4px; margin-top: 15px; overflow: hidden; display: none; }
        .progress-bar { width: 0%; height: 100%; background: var(--primary); transition: width 0.1s; }
        .file-counter { font-size: 13px; color: #64748b; margin-top: 8px; display: none; font-weight: 600; }
        
        .warning-text { font-size: 12px; color: #d97706; margin-top: 12px; display: none; font-weight: 600; background: #fef3c7; padding: 10px; border-radius: 6px; }

        .ad-slot { margin-top: 30px; width: 100%; max-width: 500px; min-height: 100px; background: #f1f5f9; border-radius: 8px; display: flex; align-items: center; justify-content: center; border: 1px dashed #cbd5e1; flex-direction: column; }
    </style>
</head>
<body>

    <div class="container">
        <h1>DineShare</h1>
        <div class="subtitle">Fast & Simple File Transfer</div>
        
        <div class="tab-buttons">
            <button class="tab-btn active" onclick="switchTab('send')">Send</button>
            <button class="tab-btn" onclick="switchTab('receive')">Receive</button>
        </div>

        <div id="sendPanel" class="panel active">
            <select id="networkMode" class="network-select">
                <option value="internet">üåê Send via Internet (Works anywhere, may use data)</option>
                <option value="local">üè† Send via Local Wi-Fi (Must be on same Wi-Fi, no data used)</option>
            </select>

            <label class="upload-btn">
                üìÑ Select Files to Send
                <input type="file" id="fileInput" multiple hidden onchange="handleFileSelect(this)">
            </label>
            
            <div id="selectionDisplay" style="margin-bottom: 20px; font-size: 15px; font-weight: bold; color: var(--primary);">0 files selected</div>
            
            <button class="action-btn" id="generateBtn" onclick="startSending()" disabled>Get Transfer Code</button>
            <div id="sendCodeDisplay" style="font-size: 40px; font-weight: bold; margin-top: 25px; letter-spacing: 8px; color: #1e293b;"></div>
            
            <div id="sendStatus" class="status">Select files to begin</div>
            <div class="progress-cont" id="sendProgressCont"><div class="progress-bar" id="sendProgressBar"></div></div>
            <div class="file-counter" id="sendFileCounter"></div>
        </div>

        <div id="receivePanel" class="panel">
            <div style="text-align: left; font-size: 14px; font-weight: 600; color: #475569; margin-top: 10px;">Enter 6-Character Code:</div>
            <input type="text" id="joinCode" placeholder="e.g. A7K9X2" maxlength="6" style="text-transform: uppercase;">
            
            <button class="action-btn" onclick="startReceiving()">Connect & Download</button>
            
            <div id="receiveStatus" class="status">Waiting for code...</div>
            <div class="progress-cont" id="receiveProgressCont"><div class="progress-bar" id="receiveProgressBar"></div></div>
            <div class="file-counter" id="receiveFileCounter"></div>
            
            <div id="downloadWarning" class="warning-text">
                Please authorize multiple downloads if prompted by your browser to ensure all files are saved.
            </div>
        </div>
    </div>

    <div class="ad-slot">
        <p style="color: #94a3b8; font-size: 12px; margin: 0;">Sponsored Content</p>
    </div>
    <script>
        // 1. FIREBASE CONFIGURATION (REPLACE WITH YOURS)

const firebaseConfig = {

  apiKey: "AIzaSyA-NhlaD3XRLKEf_y6xCMOElXnx5IVWhIg",

  authDomain: "dineshare-web.firebaseapp.com",

  databaseURL: "https://dineshare-web-default-rtdb.firebaseio.com",

  projectId: "dineshare-web",

  storageBucket: "dineshare-web.firebasestorage.app",

  messagingSenderId: "456148087993",

  appId: "1:456148087993:web:041e5569a4722b64795768",

  measurementId: "G-633V93EBW6"

};

        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // üõë ZERO-IDLE RULE 1: Disconnect immediately on page load
        db.goOffline();

        // 2. GLOBALS
        let pc, dataChannel;
        let selectedFiles = [];
        let currentRoomCode = null; 
        let connectionTimeout = null; 
        const CHUNK_SIZE = 16384; 

        // 3. UI & UTILS
        function switchTab(tab) {
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tab + 'Panel').classList.add('active');
            event.target.classList.add('active');
        }

        function handleFileSelect(inputElement) {
            if (inputElement.files.length > 0) {
                selectedFiles = Array.from(inputElement.files);
                document.getElementById('selectionDisplay').innerText = `${selectedFiles.length} file(s) ready to send`;
                document.getElementById('generateBtn').disabled = false;
            }
        }

        function getWebRTCConfig() {
            const mode = document.getElementById('networkMode').value;
            return mode === 'local' ? { iceServers: [] } : { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
        }

        function generateCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let result = '';
            for (let i = 0; i < 6; i++) result += chars.charAt(Math.floor(Math.random() * chars.length));
            return result;
        }

        // 4. SENDER LOGIC
        async function startSending() {
            if (selectedFiles.length === 0) return alert("Select files first!");

            // üü¢ ZERO-IDLE RULE 2: Wake up Firebase only when user acts
            db.goOnline();

            currentRoomCode = generateCode();
            document.getElementById('sendCodeDisplay').innerText = currentRoomCode;
            document.getElementById('sendStatus').innerText = "Waiting for receiver (Code expires in 1:30)...";
            document.getElementById('generateBtn').disabled = true;
            document.getElementById('networkMode').disabled = true;

            pc = new RTCPeerConnection(getWebRTCConfig());
            setupConnectionListeners(pc, 'sendStatus', currentRoomCode, 'sender');

            dataChannel = pc.createDataChannel("fileTransfer");
            dataChannel.onopen = () => processFileQueue();

            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);

            const roomRef = db.ref('rooms/' + currentRoomCode);
            
            roomRef.onDisconnect().remove(); 
            await roomRef.set({ offer: { type: offer.type, sdp: offer.sdp } });

            roomRef.child('answer').on('value', async (snapshot) => {
                const answer = snapshot.val();
                if (answer && !pc.currentRemoteDescription) {
                    await pc.setRemoteDescription(new RTCSessionDescription(answer));
                }
            });

            pc.onicecandidate = e => {
                if (e.candidate) roomRef.child('senderCandidates').push(e.candidate.toJSON());
            };

            roomRef.child('receiverCandidates').on('child_added', snapshot => {
                if (snapshot.val()) pc.addIceCandidate(new RTCIceCandidate(snapshot.val()));
            });

            // ‚è±Ô∏è 90-SECOND EXPIRE RULE
            connectionTimeout = setTimeout(() => {
                if (pc && pc.iceConnectionState !== 'connected') {
                    forceCleanup(currentRoomCode, true); // true = Delete the room
                    document.getElementById('sendStatus').innerText = "‚è±Ô∏è Code expired. Please generate a new one.";
                    document.getElementById('generateBtn').disabled = false;
                    document.getElementById('networkMode').disabled = false;
                    document.getElementById('sendCodeDisplay').innerText = "";
                }
            }, 90000);
        }

        async function processFileQueue() {
            document.getElementById('sendProgressCont').style.display = 'block';
            const counterLabel = document.getElementById('sendFileCounter');
            counterLabel.style.display = 'block';
            
            dataChannel.bufferedAmountLowThreshold = 1024 * 1024; 

            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                const isLastFile = i === selectedFiles.length - 1;
                
                counterLabel.innerText = `Sending file ${i + 1} of ${selectedFiles.length}`;
                document.getElementById('sendStatus').innerText = `Sending: ${file.name}`;

                dataChannel.send(JSON.stringify({ 
                    type: 'header', 
                    fileName: file.name, 
                    fileType: file.type,
                    fileSize: file.size,
                    totalFiles: selectedFiles.length
                }));

                let offset = 0;
                const readSlice = o => new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = e => resolve(e.target.result);
                    reader.readAsArrayBuffer(file.slice(o, o + CHUNK_SIZE));
                });

                while (offset < file.size) {
                    const chunk = await readSlice(offset);
                    
                    if (dataChannel.bufferedAmount > dataChannel.bufferedAmountLowThreshold) {
                        await new Promise(resolve => {
                            dataChannel.onbufferedamountlow = () => {
                                dataChannel.onbufferedamountlow = null;
                                resolve();
                            };
                        });
                    }

                    dataChannel.send(chunk);
                    offset += chunk.byteLength;
                    
                    if (offset % (CHUNK_SIZE * 50) === 0 || offset >= file.size) {
                        document.getElementById('sendProgressBar').style.width = (offset / file.size * 100) + '%';
                    }
                }
                
                dataChannel.send(JSON.stringify({ type: 'eof', isLastFile: isLastFile }));
            }
            
            document.getElementById('sendStatus').innerText = "‚úÖ All Files Sent Successfully!";
        }

        // 5. RECEIVER LOGIC
        async function startReceiving() {
            currentRoomCode = document.getElementById('joinCode').value.toUpperCase();
            if (currentRoomCode.length !== 6) return alert("Enter a valid 6-character code");

            // üü¢ ZERO-IDLE RULE 2: Wake up Firebase
            db.goOnline();

            document.getElementById('receiveStatus').innerText = "Connecting...";

            pc = new RTCPeerConnection(getWebRTCConfig());
            setupConnectionListeners(pc, 'receiveStatus', currentRoomCode, 'receiver');

            pc.ondatachannel = (event) => setupReceiveChannel(event.channel);

            const roomRef = db.ref('rooms/' + currentRoomCode);
            roomRef.onDisconnect().remove();

            const offerSnap = await roomRef.child('offer').once('value');
            const offer = offerSnap.val();

            if (!offer) {
                forceCleanup(null, false); 
                document.getElementById('receiveStatus').innerText = "‚ùå Transfer code not found.";
                return alert("Transfer code not found or expired.");
            }

            await pc.setRemoteDescription(new RTCSessionDescription(offer));
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            
            await roomRef.child('answer').set({ type: answer.type, sdp: answer.sdp });

            pc.onicecandidate = e => {
                if (e.candidate) roomRef.child('receiverCandidates').push(e.candidate.toJSON());
            };

            roomRef.child('senderCandidates').on('child_added', (snapshot) => {
                if (snapshot.val()) pc.addIceCandidate(new RTCIceCandidate(snapshot.val()));
            });

            // ‚è±Ô∏è 90-SECOND EXPIRE RULE
            connectionTimeout = setTimeout(() => {
                if (pc && pc.iceConnectionState !== 'connected') {
                    // Receiver just disconnects locally, Sender's 90s timer cleans up the DB
                    forceCleanup(currentRoomCode, false); 
                    document.getElementById('receiveStatus').innerText = "‚è±Ô∏è Connection timed out.";
                }
            }, 90000);
        }

        async function setupReceiveChannel(channel) {
            let currentFileSize = 0;
            let receivedBytes = 0;
            let fileChunks = [];
            let currentFileName = "";
            let currentFileType = "";

            document.getElementById('receiveProgressCont').style.display = 'block';
            document.getElementById('receiveFileCounter').style.display = 'block';

            channel.onmessage = async (e) => {
                if (typeof e.data === 'string') {
                    const msg = JSON.parse(e.data);
                    
                    if (msg.type === 'header') {
                        document.getElementById('receiveStatus').innerText = `Receiving: ${msg.fileName}`;
                        currentFileSize = msg.fileSize;
                        currentFileName = msg.fileName;
                        currentFileType = msg.fileType || 'application/octet-stream';
                        receivedBytes = 0;
                        fileChunks = []; 
                        
                        if (msg.totalFiles > 1) {
                            document.getElementById('downloadWarning').style.display = 'block';
                        }
                    } 
                    else if (msg.type === 'eof') {
                        const blob = new Blob(fileChunks, { type: currentFileType });
                        const url = URL.createObjectURL(blob);
                        
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = currentFileName;
                        document.body.appendChild(a);
                        a.click();
                        
                        setTimeout(() => {
                            document.body.removeChild(a);
                            URL.revokeObjectURL(url); 
                        }, 1000);
                        fileChunks = []; 

                        if (msg.isLastFile) {
                            document.getElementById('receiveStatus').innerText = "‚úÖ All Files Received Successfully!";
                            document.getElementById('receiveProgressBar').style.width = '100%';
                            document.getElementById('downloadWarning').style.display = 'none'; 
                        }
                    }
                } else {
                    fileChunks.push(e.data);
                    receivedBytes += e.data.byteLength;
                    
                    if (receivedBytes % (CHUNK_SIZE * 50) === 0 || receivedBytes >= currentFileSize) {
                        document.getElementById('receiveProgressBar').style.width = (receivedBytes / currentFileSize * 100) + '%';
                    }
                }
            };
        }

        // 6. RELIABILITY & CLEANUP LOGIC
        function setupConnectionListeners(pc, statusId, code, role) {
            pc.oniceconnectionstatechange = () => {
                const state = pc.iceConnectionState;
                
                if (state === 'connected') {
                    document.getElementById(statusId).innerText = "üü¢ Connected! Transferring...";
                    if (connectionTimeout) clearTimeout(connectionTimeout); 
                    
                    if (role === 'receiver') {
                        // üõ°Ô∏è THE 10-SECOND SHIELD: 
                        // Wait 10 seconds to ensure the Sender completely locks in before deleting DB
                        const capturedCode = code; // Capture code in scope just in case
                        setTimeout(() => {
                            forceCleanup(capturedCode, true); 
                        }, 10000); 
                    } else {
                        // Sender hangs up Firebase connection immediately (saves limits)
                        forceCleanup(code, false); 
                    }
                } 
                else if (state === 'failed' || state === 'disconnected' || state === 'closed') {
                    document.getElementById(statusId).innerText = "‚ùå Connection Lost.";
                    forceCleanup(code, true); 
                }
            };
        }

        // üßπ MASTER CLEANUP FUNCTION
        function forceCleanup(code, shouldDeleteRoom = true) {
            if (connectionTimeout) clearTimeout(connectionTimeout); 
            
            if (!code) {
                db.goOffline(); 
                return;
            }

            const roomRef = db.ref('rooms/' + code);
            
            // Stop listening to save bandwidth
            roomRef.off(); 
            roomRef.child('answer').off();
            roomRef.child('senderCandidates').off();
            roomRef.child('receiverCandidates').off();
            
            if (shouldDeleteRoom) {
                roomRef.onDisconnect().cancel(); 
                roomRef.remove().then(() => {
                    db.goOffline(); // üõë Hang up Firebase
                }).catch(() => {
                    db.goOffline(); 
                });
            } else {
                db.goOffline(); // üõë Hang up Firebase without deleting data
            }
            
            // Reset code so beforeunload doesn't fire unnecessarily
            if (currentRoomCode === code) {
                currentRoomCode = null;
            }
        }

        // üö™ If user hits back button, refreshes, or closes tab
        window.addEventListener('beforeunload', () => {
            if (currentRoomCode) {
                forceCleanup(currentRoomCode, true);
            }
        });

    </script>
</body>
</html>
