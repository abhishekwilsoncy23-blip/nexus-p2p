<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DineShare | P2P Transfer Pro</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    
    <style>
        :root { --primary: #6366f1; --bg: #f8fafc; --card: #ffffff; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; color: #1e293b; }
        .container { width: 90%; max-width: 500px; background: var(--card); margin-top: 40px; padding: 30px; border-radius: 16px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); text-align: center; }
        h1 { margin-top: 0; color: var(--primary); font-size: 26px; margin-bottom: 5px; }
        .subtitle { font-size: 13px; color: #64748b; margin-bottom: 20px; }
        
        .tab-buttons { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { flex: 1; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; background: #e2e8f0; transition: 0.3s; color: #475569; }
        .tab-btn.active { background: var(--primary); color: white; }
        .panel { display: none; }
        .panel.active { display: block; }
        
        .upload-row { display: flex; gap: 10px; margin: 15px 0; }
        .upload-btn { flex: 1; padding: 12px; background: #f1f5f9; border: 2px dashed #cbd5e1; border-radius: 8px; cursor: pointer; font-weight: 500; font-size: 14px; transition: 0.2s; }
        .upload-btn:hover { border-color: var(--primary); color: var(--primary); }
        
        select, input[type="text"] { width: 100%; padding: 12px; margin: 10px 0 15px 0; border: 2px solid #e2e8f0; border-radius: 8px; box-sizing: border-box; font-size: 15px; }
        button.action-btn { width: 100%; padding: 15px; border: none; border-radius: 8px; background: var(--primary); color: white; font-size: 16px; font-weight: bold; cursor: pointer; }
        button.action-btn:disabled { background: #94a3b8; cursor: not-allowed; }
        
        .status { margin-top: 15px; font-size: 14px; color: #64748b; min-height: 20px; font-weight: 500; }
        .progress-cont { width: 100%; height: 8px; background: #e2e8f0; border-radius: 4px; margin-top: 10px; overflow: hidden; display: none; }
        .progress-bar { width: 0%; height: 100%; background: var(--primary); transition: width 0.1s; }
        .file-counter { font-size: 12px; color: #64748b; margin-top: 5px; display: none; }
        
        .ad-slot { margin-top: 30px; width: 100%; max-width: 500px; min-height: 100px; background: #f1f5f9; border-radius: 8px; display: flex; align-items: center; justify-content: center; border: 1px dashed #cbd5e1; flex-direction: column; }
    </style>
</head>
<body>

    <div class="container">
        <h1>DineShare</h1>
        <div class="subtitle">Secure P2P File Transfer</div>
        
        <div class="tab-buttons">
            <button class="tab-btn active" onclick="switchTab('send')">Send</button>
            <button class="tab-btn" onclick="switchTab('receive')">Receive</button>
        </div>

        <div id="sendPanel" class="panel active">
            <div style="text-align: left; font-size: 13px; font-weight: 600; color: #475569;">Network Routing:</div>
            <select id="networkMode">
                <option value="internet">üåê Internet (STUN Enabled)</option>
                <option value="local">üè† Strict Local Wi-Fi (No Internet)</option>
            </select>

            <div class="upload-row">
                <label class="upload-btn">
                    üìÑ Select Files
                    <input type="file" id="fileInput" multiple hidden onchange="handleFileSelect(this)">
                </label>
                <label class="upload-btn">
                    üìÅ Select Folder
                    <input type="file" id="folderInput" webkitdirectory directory multiple hidden onchange="handleFileSelect(this)">
                </label>
            </div>
            
            <div id="selectionDisplay" style="margin-bottom: 15px; font-size: 14px; font-weight: bold; color: var(--primary);">0 files selected</div>
            
            <button class="action-btn" id="generateBtn" onclick="startSending()" disabled>Generate Transfer Code</button>
            <div id="sendCodeDisplay" style="font-size: 36px; font-weight: bold; margin-top: 20px; letter-spacing: 6px; color: #1e293b;"></div>
            
            <div id="sendStatus" class="status">Select files or a folder to begin</div>
            <div class="progress-cont" id="sendProgressCont"><div class="progress-bar" id="sendProgressBar"></div></div>
            <div class="file-counter" id="sendFileCounter"></div>
        </div>

        <div id="receivePanel" class="panel">
            <div style="text-align: left; font-size: 13px; font-weight: 600; color: #475569; margin-top: 10px;">Enter Alphanumeric Code:</div>
            <input type="text" id="joinCode" placeholder="e.g. A7K9X2" maxlength="6" style="text-transform: uppercase;">
            
            <button class="action-btn" onclick="startReceiving()">Connect & Choose Save Folder</button>
            
            <div id="receiveStatus" class="status">Waiting for code...</div>
            <div class="progress-cont" id="receiveProgressCont"><div class="progress-bar" id="receiveProgressBar"></div></div>
            <div class="file-counter" id="receiveFileCounter"></div>
        </div>
    </div>

    <div class="ad-slot">
        <p style="color: #94a3b8; font-size: 12px; margin: 0;">Sponsored Content</p>
    </div>

    <script>
        // 1. FIREBASE CONFIGURATION (REPLACE WITH YOURS)
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            databaseURL: "https://YOUR_PROJECT-default-rtdb.firebaseio.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "YOUR_ID",
            appId: "YOUR_APP_ID"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // 2. GLOBALS
        let pc, dataChannel;
        let selectedFiles = [];
        let rootDirectoryHandle = null; 
        const CHUNK_SIZE = 16384; 

        // 3. UI & UTILS
        function switchTab(tab) {
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tab + 'Panel').classList.add('active');
            event.target.classList.add('active');
        }

        function handleFileSelect(inputElement) {
            if (inputElement.files.length > 0) {
                selectedFiles = Array.from(inputElement.files);
                document.getElementById('selectionDisplay').innerText = `${selectedFiles.length} file(s) ready to send`;
                document.getElementById('generateBtn').disabled = false;
            }
        }

        function getWebRTCConfig() {
            const mode = document.getElementById('networkMode').value;
            return mode === 'local' ? { iceServers: [] } : { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
        }

        function generateCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // Excluded I, O, 1, 0 for clarity
            let result = '';
            for (let i = 0; i < 6; i++) result += chars.charAt(Math.floor(Math.random() * chars.length));
            return result;
        }

        // 4. SENDER LOGIC
        async function startSending() {
            if (selectedFiles.length === 0) return alert("Select files first!");

            const code = generateCode();
            document.getElementById('sendCodeDisplay').innerText = code;
            document.getElementById('sendStatus').innerText = "Waiting for receiver...";

            pc = new RTCPeerConnection(getWebRTCConfig());
            setupConnectionListeners(pc, 'sendStatus');

            dataChannel = pc.createDataChannel("fileTransfer");
            dataChannel.onopen = () => processFileQueue();

            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);

            const roomRef = db.ref('rooms/' + code);
            roomRef.set({ offer: { type: offer.type, sdp: offer.sdp } });

            roomRef.on('value', async (snapshot) => {
                const data = snapshot.val();
                if (data?.answer && !pc.currentRemoteDescription) {
                    await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
                }
            });

            pc.onicecandidate = e => {
                if (e.candidate) roomRef.child('senderCandidates').push(e.candidate.toJSON());
            };

            roomRef.child('receiverCandidates').on('child_added', snapshot => {
                pc.addIceCandidate(new RTCIceCandidate(snapshot.val()));
            });
        }

        async function processFileQueue() {
            document.getElementById('sendProgressCont').style.display = 'block';
            const counterLabel = document.getElementById('sendFileCounter');
            counterLabel.style.display = 'block';
            
            dataChannel.bufferedAmountLowThreshold = 1024 * 1024; // 1MB buffer

            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                // webkitRelativePath contains the folder structure if a folder was selected
                const path = file.webkitRelativePath || file.name; 
                
                counterLabel.innerText = `Sending file ${i + 1} of ${selectedFiles.length}`;
                document.getElementById('sendStatus').innerText = `Sending: ${file.name}`;

                // Send Metadata Header
                dataChannel.send(JSON.stringify({ 
                    type: 'header', 
                    fileName: path, 
                    fileSize: file.size,
                    isLastFile: i === selectedFiles.length - 1
                }));

                // Read and Send Chunks
                let offset = 0;
                const readSlice = o => new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = e => resolve(e.target.result);
                    reader.readAsArrayBuffer(file.slice(o, o + CHUNK_SIZE));
                });

                while (offset < file.size) {
                    const chunk = await readSlice(offset);
                    
                    if (dataChannel.bufferedAmount > dataChannel.bufferedAmountLowThreshold) {
                        await new Promise(resolve => {
                            dataChannel.onbufferedamountlow = () => {
                                dataChannel.onbufferedamountlow = null;
                                resolve();
                            };
                        });
                    }

                    dataChannel.send(chunk);
                    offset += chunk.byteLength;
                    
                    if (offset % (CHUNK_SIZE * 50) === 0 || offset >= file.size) {
                        document.getElementById('sendProgressBar').style.width = (offset / file.size * 100) + '%';
                    }
                }
                
                // Signal end of current file
                dataChannel.send(JSON.stringify({ type: 'eof' }));
            }
            
            document.getElementById('sendStatus').innerText = "‚úÖ All Files Sent Successfully!";
            cleanup(document.getElementById('sendCodeDisplay').innerText);
        }

        // 5. RECEIVER LOGIC
        async function startReceiving() {
            if (!window.showDirectoryPicker) {
                return alert("Your browser doesn't support silent folder writing. Please use Chrome, Edge, or Brave on Desktop.");
            }

            const code = document.getElementById('joinCode').value.toUpperCase();
            if (code.length !== 6) return alert("Enter a valid 6-character code");

            try {
                // Ask user where to save files BEFORE connecting
                rootDirectoryHandle = await window.showDirectoryPicker();
            } catch (err) {
                return alert("You must select a folder to save the incoming files.");
            }

            document.getElementById('receiveStatus').innerText = "Connecting...";

            pc = new RTCPeerConnection(getWebRTCConfig());
            setupConnectionListeners(pc, 'receiveStatus');

            pc.ondatachannel = (event) => setupReceiveChannel(event.channel);

            const roomRef = db.ref('rooms/' + code);
            const snapshot = await roomRef.once('value');
            const data = snapshot.val();

            if (!data) return alert("Room not found!");

            await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            roomRef.update({ answer: { type: answer.type, sdp: answer.sdp } });

            pc.onicecandidate = e => {
                if (e.candidate) roomRef.child('receiverCandidates').push(e.candidate.toJSON());
            };

            roomRef.child('senderCandidates').on('child_added', (snapshot) => {
                pc.addIceCandidate(new RTCIceCandidate(snapshot.val()));
            });
        }

        async function setupReceiveChannel(channel) {
            let activeWriter = null;
            let currentFileSize = 0;
            let receivedBytes = 0;

            document.getElementById('receiveProgressCont').style.display = 'block';
            document.getElementById('receiveFileCounter').style.display = 'block';

            channel.onmessage = async (e) => {
                if (typeof e.data === 'string') {
                    const msg = JSON.parse(e.data);
                    
                    if (msg.type === 'header') {
                        document.getElementById('receiveStatus').innerText = `Writing: ${msg.fileName}`;
                        currentFileSize = msg.fileSize;
                        receivedBytes = 0;

                        // Recreate folder structure if it exists in the path
                        const pathParts = msg.fileName.split('/');
                        const fileName = pathParts.pop(); // Remove file name, keep folders
                        let currentDirHandle = rootDirectoryHandle;

                        for (const folder of pathParts) {
                            currentDirHandle = await currentDirHandle.getDirectoryHandle(folder, { create: true });
                        }

                        // Create file and open writable stream
                        const fileHandle = await currentDirHandle.getFileHandle(fileName, { create: true });
                        activeWriter = await fileHandle.createWritable();
                    } 
                    else if (msg.type === 'eof') {
                        // File complete
                        await activeWriter.close();
                        activeWriter = null;
                        if (msg.isLastFile) {
                            document.getElementById('receiveStatus').innerText = "‚úÖ All Files Received Successfully!";
                        }
                    }
                } else {
                    // Binary chunk
                    if (activeWriter) {
                        receivedBytes += e.data.byteLength;
                        await activeWriter.write(e.data);
                        
                        // Update UI
                        if (receivedBytes % (CHUNK_SIZE * 50) === 0 || receivedBytes >= currentFileSize) {
                            document.getElementById('receiveProgressBar').style.width = (receivedBytes / currentFileSize * 100) + '%';
                        }
                    }
                }
            };
        }

        // 6. STABILITY & CLEANUP
        function setupConnectionListeners(pc, statusId) {
            pc.oniceconnectionstatechange = () => {
                const state = pc.iceConnectionState;
                if (state === 'connected') {
                    document.getElementById(statusId).innerText = "üü¢ Connected! Transferring...";
                } else if (state === 'failed' || state === 'disconnected') {
                    document.getElementById(statusId).innerText = "‚ùå Connection Lost.";
                }
            };
        }

        function cleanup(code) {
            setTimeout(() => { db.ref('rooms/' + code).remove(); }, 5000);
        }
    </script>
</body>
</html>
